<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body { margin:0;position:relative;top:0;right:0;bottom:0;left:0; }
    .hidden {
        display: none;
    }
    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute;
    }
    
    
    .ticks {
  		font: 10px sans-serif;
    }

    .track,
    .track-inset,
    .track-overlay {
      stroke-linecap: round;
    }

    .track {
      stroke: #000;
      stroke-opacity: 0.3;
      stroke-width: 4px;
    }

    .track-inset {
      stroke: #ddd;
      stroke-width: 9px;
    }

    .track-overlay {
      pointer-events: stroke;
      stroke-width: 10px;
      stroke: transparent;
      cursor: crosshair;
    }

    .handle {
      fill: #fff;
      stroke: #000;
      stroke-opacity: 0.5;
      stroke-width:2px;
    }
    
      #mapinter {
      position: absolute;
    }
    
	
    .slider {
      padding-top: 450px;
      padding-left: 40px;
      width : 100%
    }
    
    .pays {
      stroke : #040801;
      stroke-width : 0.06px;
    }
    
    .paysselect {
      stroke : #ffffff;
      stroke-width : 2.2px;
    }
    
    .centres {
      fill: #7aff92;
      stroke: #91d94e;
      opacity: 0.8;
      stroke-width: 0.5px;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .route {
    fill: none;
    stroke-width: 0;
		}
    
    .plane {
     fill: #fff;
     stroke-width: 1;
	  }	
    
    #update{
      position : absolute;
      padding-top: 350px;
      padding-left: 30px
    }



  /* global btn styles */
  .btn {
    display: inline-block;
    font-size: 90%;
    text-decoration: none;
    border-radius: 5px;
    transition: background ease .3s;
  }

  /* buy btn */
  .btn-departure {
    background: #27AE60;
    font-weight: bold;
    color: #fff;
    padding: 12px;
        /*  border: 3px solid #4CAF50; */
  }

  .btn-departure:hover {
    background: #2ECC71;
    
  }

  /* sign in btn */
  .btn-arrival {
    padding: 8px;
    background: #2980B9;
    color: #fff;
    font-weight: bold;
  }

  .btn-arrival:hover {
    background: #3498DB;
}
  </style>
</head>

<body>
          <div id="map">
            
           <div id="mapinter">
            </div>
            
            <div id="update">
              <a id="departure" class="btn btn-departure">Departure</a>
							<a id="arrival" class="btn btn-arrival">Arrival</a>
            </div>

        </div>

  <script> 
		var width = 1000,
  		  height = 580;
    
    d3.select('div#mapinter')
    .style('width',"130px")
    .style('height',"400px")
    
    var zoom = d3.zoom().on("zoom", function () {
       															 svg.attr("transform", d3.event.transform)
     																})
    .scaleExtent([1, 6]);
    //on fixe le zoom (et sa fonction translate) de manière à ne pas pouvoir déplacer la carte n'importe comment (ou hors de sa position d'origine)
    zoom.translateExtent([[0,0],[width,height]])
    
		var svg = d3.select("#map" ) 
  		.append( "svg" )
		  .attr( "width", width )
		  .attr( "height", height )
    	.style("background-color","#c7eae5")
     .call(zoom)
    .append("g");
    
    var slider = d3.select("#mapinter").append("svg") 
    .attr("class", "slider");
    
    
    var x = d3.scaleLinear()
    .domain([10, 17])
    .range([0, 120])
    .clamp(true);
    
    
    var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');
    
    var projection = d3.geoConicConformal() 
    									.translate([width/2, height/2])
    									.center([-8, 50]).scale(745);
    
    var path = d3.geoPath() // d3.geo.path avec d3 version 3
                 .projection(projection);
    
    

    
    
    //creation d'un dico {"code dans data.json" : "indice dans customgeo"}  
    var noms = {"CZ" : {nom : "Tchéquie",ind : 1},"FI" : {nom : "Finlande",ind : 13},"BE" : {nom : "Belgique",ind : 5},"BG" : {nom : "Bulgarie",ind : 6},"AT" : {nom : "Autriche",ind : 7},"CH" : {nom : "Suisse",ind : 9},"DK" : {nom : "Danemark",ind : 10},"ES" : {nom : "Espagne",ind : 11},"DE" : {nom : "Allemagne",ind : 14},"EE" : {nom : "Estonie",ind : 15},"FR" : {nom : "France",ind : 16},"HR" : {nom : "Croatie",ind : 17},"EL" : {nom : "Grece",ind : 18},"UK" : {nom : "Royaume-uni",ind : 19},"HU" : {nom : "Hongrie",ind : 22},"IE" : {nom : "Irlande",ind : 23},"IS" : {nom : "Islande",ind : 25},"LT" : {nom : "Lituanie",ind : 26},"IT" : {nom : "Italie",ind : 27},"LU" : {nom : "Luxembourg",ind : 31},"LV" : {nom : "Lettonie",ind : 33},"MK" : {nom : "Macedoine",ind : 34},"ME" : {nom : "Montenegro",ind : 35},"MT" : {nom : "Malte",ind : 36},"PT" : {nom : "Portugal",ind : 37},"NO" : {nom : "Norvège",ind : 38},"NL" : {nom : "Pays-bas",ind : 39},"PL" : {nom : "Pologne",ind : 40},"RO" : {nom : "Roumanie",ind : 41},"SK" : {nom : "Slovaquie",ind : 45},"SI" : {nom : "Slovenie",ind : 46},"SE" : {nom : "Suède",ind : 48},"TR" : {nom : "Turquie",ind : 50},}
    
    
    function recupcode(indice){ //dans la var noms retrouve le code en fonction de l'indice
     var value; 
      Object.keys(noms).forEach(function(e){
                                   		 if(noms[e].ind==indice){
                                         value = e;
                                       }
      })
                                          if(value){return value}else{return "NA"};
                               };//QUAND PAYS NON INDEXE on affichera NO DATA
    //console.log(recupcode(50))
     
    			//console.log(europe.features[noms.AT.ind].properties.name)
      
    var color = d3.scaleQuantize()
    	.range(['#ffffff','#f4fef4','#eafeea','#e0fde0','#d5fdd5','#cbfdcb','#c1fcc1','#b6fcb6','#acfbac',
'#a2fba2','#98fb98','#98fb98','#88e188','#79c879','#6aaf6a','#5b965b','#4c7d4c','#3c643c','#2d4b2d',
'#1e321e','#0f190f','#000000'
])
    
    //creation d'une var max qui stocke le max des differentes années dans les 2 sens
     var max={"2010" : {"DEP" : 0, "ARR" : 0 },"2011" : {"DEP" :0 , "ARR" :0 },"2012" : {"DEP" :0 , "ARR" :0 },"2013" : {"DEP" :0 , "ARR" :0 },"2014" : {"DEP" : 0, "ARR" :0 },"2015" : {"DEP" :0 , "ARR" : 0},"2016" : {"DEP" : 0, "ARR" : 0},"2017" : {"DEP" : 0, "ARR" : 0}}   
     
     var dir={"DEP" : "Departures","ARR": "Arrivals"}
    
     
    var currentyear = 2010
    var currentdir = "DEP";
    //console.log(dir[currentdir])
    
    // A METTRE DANS FCT QUEUE
    d3.json("centres.json",function(centres){
    d3.json("data.json",function(json){
    d3.json("custom.geo.json", function(europe){
                  
                  
                  //on récupère les max des départs et ARRivées pour chaque année :
                  Object.keys(json).forEach(function(d){
                    for(var i = 2010;i<=2017;i++){
                      max[i].DEP=d3.max([max[i].DEP,parseInt(json[d].DEP[i].Total)])
                      max[i].ARR=d3.max([max[i].ARR,parseInt(json[d].ARR[i].Total)])
                    }
                  })
                  
                  color.domain([0,1]);
                  
                  	
                        svg.selectAll("path")
                             .data(europe.features)
                             .enter()
                             .append("path")
                             .attr("d", path)
                            .style("fill",'lightgrey');
                      //On donne un identifiant à chaque feature qu'on retrouve dans noms :
                      	for(var i = 0;i<europe.features.length;i++){
                          europe.features[i].ident=i
                        }
                      
                      
                      
                      //////////////////////
                      //
                      //PARTIE COLO + TOOLTIP
                      //
                      //////////////////////
                      
                      
                      	svg.selectAll("path")
                        		.attr("class","pays")
                        		.style("fill",function(d) {
                          				var value
                                  Object.keys(noms).forEach(function(e){
                                   		 if(noms[e].ind==d.ident){
                                         value = json[e][currentdir][currentyear].Total/max[currentyear][currentdir]
                                       }
                                   })
                                if (value) {
                                  return color(value);
                                  } else {
                                  return 'lightgrey';
                                  }})
                            .on('mousemove',function(d){
                                var mouse = d3.mouse(svg.node())
                                              .map(function(d) {
                                                  return parseInt(d);
                                              		});
                          //console.log(json[recupcode(d.ident)])
                          //modifions l'apparence des pays sur lesquels on passe :
                          				d3.select(this).attr("class","paysselect");
                          //on affiche le tooltip :
                                 tooltip.classed('hidden', false) 
                                        .attr('style', 'left:' + (mouse[0] + 15) +
                                                  'px; top:' + (mouse[1] - 35) + 'px');
                          
                          
                          if(recupcode(d.ident)=="NA"){
                            tooltip.html(d.properties.sovereignt+ "<br>" +"No Data");
                          }else{tooltip.html(d.properties.sovereignt+ "<br>" +dir[currentdir]+" in "+currentyear+" : "+Intl.NumberFormat().format(json[recupcode(d.ident)][currentdir][currentyear].Total));

                              }})//gere la selection lors du mvt de la souris
                            .on('mouseout', function() {
                          d3.select(this).attr("class","pays")
                                  tooltip.classed('hidden', true);
                              });
                      
                      
                          svg.append("g")
        										 .attr("class", "centres")
     										    .selectAll("path")
         										.data(centres.features)
       										  .enter()
                             .append("path")
                             .attr("d", path);
                      
                      
                      
                      //////////////////////
                      //
                      //PARTIE SUR LES ROUTES
                      //
                      //////////////////////
                    //console.log( getroutes("IT",1)) 
                      
                      function getroutes(pays,prop){//fonction qui recup les donnees necessaires au tracage des routes pour le pays en param
                        var dataroutes = [];
                        var i =0;
                        j=json[pays][currentdir][currentyear];
                        Object.keys(noms).forEach(function(e){
                          if(json[pays][currentdir][currentyear][noms[e].nom]){
                            if(currentdir=="DEP"){
                          dataroutes[i]={"trajet" : [pays,e],"nb" :(j[noms[e].nom]/j["Total"])};
                            }else{
                              dataroutes[i]={"trajet" : [e,pays],"nb" :(j[noms[e].nom]/j["Total"])};
                            }
                            
                        i++}
                           ;})
                        console.log(dataroutes)
                            var test =0;
                        for(i in dataroutes){
                          test+=dataroutes[i].nb
                        }
                        //console.log(test)
                        return dataroutes;
                        }
                      
                     // console.log(projection(centres.features[1].geometry.coordinates))
                      
                       				
                      function indicedanscentres(pays){
                        for(i in centres.features){
                           if(centres.features[i].properties.nom == pays){
                             var paysind = i;
                           }
                        }
                        return paysind
                      }//retrouve l'indice à chercher dans centres pour tel pays IMPORTANT
      
                      function centresmap(pays){
                        return centres.features[indicedanscentres(pays)].geometry.coordinates;
                      }//renvoie les coord d'un pays IMPORTANT
                      
                      
                      
      
                      
                      
                      //////////////////////
                      //
                      //PARTIE ANIMAVION
                      //
                      //////////////////////
                      
                      
    
                    function transition(plane, route) {
                    var l = route.node()
                    						 .getTotalLength();
                    		plane.transition()
                            .duration(l * 75)   //c'est ici qu'on changera la vitesse
                            .attrTween("transform", delta(plane, route.node())) 
                            //.each("end", function() { route.remove(); }) //A DECOMMENT QD >1 AV
                            .remove();
                   	}
    
                    function delta(plane, path) {
                      var l = path.getTotalLength();
                      var plane = plane;
                      return function(i) {
                        return function(t) {
                          var p = path.getPointAtLength(t * l);

                          var t2 = Math.min(t + 0.05, 1);
                          var p2 = path.getPointAtLength(t2 * l);

                          var x = p2.x - p.x;
                          var y = p2.y - p.y;
                          var r = 90 - Math.atan2(-y, x) * 180 / Math.PI;

                          var s = Math.min(Math.sin(Math.PI * t) * 0.7, 0.3);

                          return "translate(" + p.x + "," + p.y + ") scale(" + s + ") rotate(" + r + ")";
                        }
                      }
  									}
    

                      function fly(origin, destination) {
                        var route = svg.append("path")
                                       .datum({type: "LineString", coordinates: [centresmap(origin), centresmap(destination)]})
                                       .attr("class", "route")
                                       .attr("d", path);

                        var plane = svg.append("path")
                                       .attr("class", "plane")
                                       .attr("d", "m25.21488,3.93375c-0.44355,0 -0.84275,0.18332 -1.17933,0.51592c-0.33397,0.33267 -0.61055,0.80884 -0.84275,1.40377c-0.45922,1.18911 -0.74362,2.85964 -0.89755,4.86085c-0.15655,1.99729 -0.18263,4.32223 -0.11741,6.81118c-5.51835,2.26427 -16.7116,6.93857 -17.60916,7.98223c-1.19759,1.38937 -0.81143,2.98095 -0.32874,4.03902l18.39971,-3.74549c0.38616,4.88048 0.94192,9.7138 1.42461,13.50099c-1.80032,0.52703 -5.1609,1.56679 -5.85232,2.21255c-0.95496,0.88711 -0.95496,3.75718 -0.95496,3.75718l7.53,-0.61316c0.17743,1.23545 0.28701,1.95767 0.28701,1.95767l0.01304,0.06557l0.06002,0l0.13829,0l0.0574,0l0.01043,-0.06557c0,0 0.11218,-0.72222 0.28961,-1.95767l7.53164,0.61316c0,0 0,-2.87006 -0.95496,-3.75718c-0.69044,-0.64577 -4.05363,-1.68813 -5.85133,-2.21516c0.48009,-3.77545 1.03061,-8.58921 1.42198,-13.45404l18.18207,3.70115c0.48009,-1.05806 0.86881,-2.64965 -0.32617,-4.03902c-0.88969,-1.03062 -11.81147,-5.60054 -17.39409,-7.89352c0.06524,-2.52287 0.04175,-4.88024 -0.1148,-6.89989l0,-0.00476c-0.15655,-1.99844 -0.44094,-3.6683 -0.90277,-4.8561c-0.22699,-0.59493 -0.50356,-1.07111 -0.83754,-1.40377c-0.33658,-0.3326 -0.73578,-0.51592 -1.18194,-0.51592l0,0l-0.00001,0l0,0z");

                      transition(plane, route);
                    }


flyroutes("IT") 

									
							function flyroutes(pays){
                var routes=getroutes(pays,1)
									var t=0;
                  setInterval(function() {
                        if (t > routes.length - 1) {
                          t = 0;
                        }
                    //console.log(routes[t].trajet) 
                        var od = routes[t].trajet;
                        fly(od[0], od[1]);
                        t++;
                      }, 400);
                      
              }
      
      
                      
                      //////////////////////
                      //
                      //PARTIE SLIDER
                      //
                      //////////////////////
                                         
      
      
      
                          slider.append("line")
                            .attr("class", "track")
                            .attr("x1", x.range()[0])
                            .attr("x2", x.range()[1])
                            .attr('y1',10)
                            .attr('y2',10)
                            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); }) 
                            .attr("class", "track-inset")
                          	.select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                            .attr("class", "track-overlay")
                            .call(d3.drag()
                                .on("start.interrupt", function() { slider.interrupt(); })
                                .on("start drag", function() { hue(Math.round(x.invert(d3.event.x))); })
                                 );
                      
                      
                      		slider.insert("g", ".track-overlay")
                            .attr("class", "ticks")
                            .attr("transform", "translate(0," + 26 + ")")
                            .selectAll("text")
                            .data(x.ticks(5))
                            .enter().append("text")
                            .attr("x", x)
                            .attr("text-anchor", "middle")
                            .text(function(d) { return d; });

                       var handle = slider.insert("circle", ".track-overlay")
                            .attr("class", "handle")
                      		  .attr("cy",10)
                            .attr("r", 6);
 
                      
                      function hue(h) { 
                        handle.attr("cx", x(h));
                        updateyear(h);
                      }//Update la position sur le slider et appelle d'autres updates
                      
                                            
      
      
                      
                      //////////////////////
                      //
                      //PARTIE BOUTONS
                      //
                      //////////////////////
                                          
      
      
      
                      document.getElementById("departure").onclick = function updatedir(){
                    if(currentdir == "ARR"){
                      currentdir = "DEP"
                        document.getElementById("departure").setAttribute("style","padding: 12px")
                                            		  document.getElementById("arrival").setAttribute("style","padding: 8px")

                    }else{
                    }
                        update()
                      }
                      
        	     		 document.getElementById("arrival").onclick = function updatedir(){
                    		if(currentdir == "DEP"){
                      				currentdir = "ARR"; document.getElementById("departure").setAttribute("style","padding: 8px");  document.getElementById("arrival").setAttribute("style","padding: 12px")
                    }else{
                    }
                        update()
                      }
                      
                   
                   
                   
                   
                      
                      //////////////////////
                      //
                      //PARTIE UPDATE
                      //
                      //////////////////////
                            
                   		function updateyear(h){
                        currentyear = 2000+h
                        update()
                      }
                   
                      function update(){
                        svg.selectAll("path").style("fill",function(d) {
                          		var value;
                          console.log(d)
                                  Object.keys(noms).forEach(function(e){
                                   		 if(noms[e].ind==d.ident){
                                         value = json[e][currentdir][currentyear].Total/max[currentyear][currentdir]
                                       }
                                  })
                                if (value) {
                                  return color(value);
                                  } else {
                                  return 'lightgrey';
                                  }
                                                                       });
                        //on update les centres aussi
                        //SUPPRIMER CEUX DES PAYS NON REPRESENTES ?
                          svg.append("g")
        										 .attr("class", "centres")
     										    .selectAll("path")
         										.data(centres.features)
       										  .enter()
                             .append("path")
                             .attr("id", function(d) {return d.id;})
                             .attr("d", path);
                      
                      flyroutes("IT") 
                      }//Update la couleur des pays. Est appelée par le slider(via hue)
                      
                    
                  
    });
	  });
    })
     
    
   
  </script>
</body>